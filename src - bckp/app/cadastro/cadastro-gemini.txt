'use client';

import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, getDocs, query } from 'firebase/firestore';

// --- Substituições de Ícones (para torná-lo autocontido) ---
const ZapIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}>
    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
  </svg>
);

const UserPlusIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}>
    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
    <circle cx="9" cy="7" r="4" />
    <line x1="19" x2="19" y1="8" y2="14" />
    <line x1="22" x2="16" y1="11" y2="11" />
  </svg>
);

// --- Componente da Página de Cadastro ---

export default function CadastroPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);

  const colors = {
    gold: '#FFD700',
    dark: '#1a1a1a',
    card: '#242424',
  };

  // 1. Configuração do Firebase e Autenticação
  useEffect(() => {
    const setupFirebase = async () => {
      try {
        // O appId pode vir com o caminho do arquivo (ex: 'c_.../src/app/cadastro/page.tsx').
        // Extraímos apenas o ID da aplicação se necessário, mas para caminhos privados/de teste,
        // é mais seguro apenas remover a query de teste que estava causando o erro.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        if (!Object.keys(firebaseConfig).length) {
          console.error("Firebase config is missing.");
          setMessage("Erro: Configuração do Firebase não encontrada.");
          return;
        }

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const firebaseAuth = getAuth(app);

        // Autenticação com Token Customizado ou Anônima
        if (typeof __initial_auth_token !== 'undefined') {
          await signInWithCustomToken(firebaseAuth, __initial_auth_token);
        } else {
          await signInAnonymously(firebaseAuth);
        }

        const currentUserId = firebaseAuth.currentUser?.uid || crypto.randomUUID();
        
        setDb(firestore);
        setAuth(firebaseAuth);
        setUserId(currentUserId);
        
        // CORREÇÃO: A consulta de teste abaixo foi removida.
        // Ela estava usando uma combinação de __app_id e um caminho público que resultava em
        // um número par de segmentos, o que é inválido para referências de coleção.
        /*
        const q = query(collection(firestore, `/artifacts/${appId}/public/data/users`));
        const userSnapshot = await getDocs(q);
        console.log(`Total de usuários públicos encontrados: ${userSnapshot.docs.length}`);
        */
        
      } catch (error) {
        console.error("Firebase setup error:", error);
        // Garante que a mensagem de erro da inicialização não sobrescreva a mensagem principal de cadastro.
        if (!message) {
            setMessage(`Erro de inicialização: ${error.message}`);
        }
      }
    };

    setupFirebase();
  }, []); // Dependências vazias garantem que roda apenas uma vez

  // 2. Função de Cadastro
  const handleCadastro = async (e) => {
    e.preventDefault();
    if (!db || !userId) {
      setMessage("Aguarde a inicialização do sistema...");
      return;
    }

    if (!name || !email || !password) {
        setMessage("Preencha todos os campos.");
        return;
    }
    
    if (password.length < 8) {
        setMessage("A senha deve ter no mínimo 8 caracteres.");
        return;
    }

    setIsLoading(true);
    setMessage('');

    try {
      // Usando o appId para criar o caminho de coleção (garante que está no escopo do app)
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      
      // Armazenamento no caminho privado do usuário (Coleção: registration_data, Documento: profile)
      // Caminho: /artifacts/{appId}/users/{userId}/registration_data/profile
      const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/registration_data`, 'profile');

      await setDoc(userDocRef, {
        name: name,
        email: email,
        // Aviso: Em um app real, a senha NUNCA deve ser salva diretamente no Firestore.
        // Aqui, a salvamos apenas para demonstrar a persistência do dado no DB.
        password_mock: password, // Alterei o nome do campo para enfatizar que é um mock.
        registeredAt: new Date().toISOString(),
      });

      setMessage('Cadastro realizado com sucesso! Bem-vindo ao StyloHub Premium.');
      // Opcional: Limpar formulário
      setName('');
      setEmail('');
      setPassword('');

    } catch (error) {
      console.error("Erro ao registrar usuário:", error);
      setMessage(`Erro no cadastro: ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div style={{ backgroundColor: colors.dark }} className="min-h-screen flex items-center justify-center p-4 sm:p-8">
      
      <div 
        style={{ backgroundColor: colors.card, boxShadow: `0 0 30px rgba(255, 215, 0, 0.2)` }}
        className="w-full max-w-md p-8 sm:p-10 rounded-xl space-y-6 text-gray-100 border border-yellow-800/50"
      >
        <div className="text-center">
          <UserPlusIcon className="w-12 h-12 mx-auto" style={{ color: colors.gold }} />
          <h1 className="text-3xl font-bold mt-4" style={{ color: colors.gold }}>
            Crie sua Conta Premium
          </h1>
          <p className="text-sm text-gray-400 mt-1">
            Sua jornada para a excelência na barbearia começa aqui.
          </p>
        </div>

        {/* Exibir ID do Usuário (Obrigatório para Apps Multi-usuário) */}
        <p className="text-xs text-gray-500 break-words pt-2">
            **ID do Usuário Ativo:** {userId || "Aguardando autenticação..."}
        </p>

        <form onSubmit={handleCadastro} className="space-y-4">
          
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-1" htmlFor="name">Nome Completo</label>
            <input
              id="name"
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              disabled={isLoading}
              required
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500 text-white transition duration-200"
              placeholder="Seu nome"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-300 mb-1" htmlFor="email">E-mail</label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              disabled={isLoading}
              required
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500 text-white transition duration-200"
              placeholder="voce@seuemail.com"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-300 mb-1" htmlFor="password">Senha</label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              disabled={isLoading}
              required
              className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500 text-white transition duration-200"
              placeholder="Mínimo 8 caracteres"
            />
          </div>
          
          <button
            type="submit"
            disabled={isLoading}
            className={`w-full p-3 mt-4 text-lg rounded-lg font-bold transition duration-300 
                        ${isLoading 
                          ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                          : 'bg-gradient-to-r from-yellow-500 to-amber-600 text-gray-900 shadow-lg shadow-yellow-500/30 hover:shadow-yellow-500/50'
                        }`}
          >
            {isLoading ? 'Registrando...' : (
              <>
                <ZapIcon className="w-5 h-5 inline mr-2" />
                Criar Conta
              </>
            )}
          </button>
        </form>

        {message && (
          <div className={`p-3 rounded-lg text-center font-medium text-sm ${message.startsWith('Erro') ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'}`}>
            {message}
          </div>
        )}

        <div className="text-center text-sm text-gray-400 pt-4">
          Já tem conta?{' '}
          {/* Link para a página de login (simulada) */}
          <a href="/login" className="text-yellow-500 hover:text-yellow-400 font-medium">
            Entrar agora
          </a>
        </div>
        
      </div>
    </div>
  );
}